openapi: 3.0.3
info:
  title: Insurance App API
  description: |
    Backend API for Romanian insurance company managing building insurance policies.
    
    **User Roles:**
    - Brokers: Manage clients, buildings, and policies
    - Administrators: Manage brokers, metadata (currencies, fees, risk factors), and view reports
  version: 0.0.1-SNAPSHOT
  contact:
    name: Endava Training
    email: training@endava.com

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: http://localhost:8080
    description: Docker environment

tags:
  - name: Clients
    description: Client management operations for brokers
  - name: Buildings
    description: Building (insurance object) management operations
  - name: Geography
    description: Geographic data (countries, counties, cities)
  - name: Policies
    description: Insurance policy management operations for brokers
  - name: Brokers (Admin)
    description: Broker management operations for administrators
  - name: Currencies (Admin)
    description: Currency management operations for administrators
  - name: Fees (Admin)
    description: Fee configuration management operations for administrators
  - name: Risk Factors (Admin)
    description: Risk factor management operations for administrators
  - name: Reports (Admin)
    description: Policy reporting operations for administrators

paths:
  /api/brokers/clients:
    get:
      tags:
        - Clients
      summary: Search clients
      description: Search clients by name and/or identification number with pagination
      operationId: searchClients
      parameters:
        - name: name
          in: query
          description: Client name (partial match, case-insensitive)
          required: false
          schema:
            type: string
            example: "John"
        - name: identificationNumber
          in: query
          description: CNP or CUI (exact match)
          required: false
          schema:
            type: string
            example: "1234567890123"
        - name: page
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Page size
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: sort
          in: query
          description: Sort field and direction
          required: false
          schema:
            type: string
            default: "name,asc"
            example: "name,asc"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageDtoClientResponse'

    post:
      tags:
        - Clients
      summary: Create new client
      description: Create a new client (individual or company)
      operationId: createClient
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateClientRequest'
      responses:
        '201':
          description: Client created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '409':
          description: Duplicate identification number
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/brokers/clients/{clientId}:
    get:
      tags:
        - Clients
      summary: Get client by ID
      description: Retrieve client details including identification number change history
      operationId: getClientById
      parameters:
        - name: clientId
          in: path
          required: true
          description: Client UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponse'
        '404':
          description: Client not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

    put:
      tags:
        - Clients
      summary: Update client
      description: Update client information. Changes to identificationNumber are automatically tracked.
      operationId: updateClient
      parameters:
        - name: clientId
          in: path
          required: true
          description: Client UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateClientRequest'
      responses:
        '200':
          description: Client updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Client not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '409':
          description: Duplicate identification number
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/brokers/clients/{clientId}/buildings:
    get:
      tags:
        - Buildings
      summary: Get buildings by client
      description: Retrieve all buildings owned by a specific client
      operationId: getBuildingsByClient
      parameters:
        - name: clientId
          in: path
          required: true
          description: Client UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BuildingResponse'
        '404':
          description: Client not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

    post:
      tags:
        - Buildings
      summary: Create new building
      description: Register a new building for a client
      operationId: createBuilding
      parameters:
        - name: clientId
          in: path
          required: true
          description: Owner client UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBuildingRequest'
      responses:
        '201':
          description: Building created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BuildingResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Client or City not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/brokers/buildings/{buildingId}:
    get:
      tags:
        - Buildings
      summary: Get building by ID
      description: Retrieve building details with full geography information
      operationId: getBuildingById
      parameters:
        - name: buildingId
          in: path
          required: true
          description: Building UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BuildingResponse'
        '404':
          description: Building not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

    put:
      tags:
        - Buildings
      summary: Update building
      description: Update building information. Owner cannot be changed (immutable).
      operationId: updateBuilding
      parameters:
        - name: buildingId
          in: path
          required: true
          description: Building UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateBuildingRequest'
      responses:
        '200':
          description: Building updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BuildingResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Building or City not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/brokers/countries:
    get:
      tags:
        - Geography
      summary: Get all countries
      description: Retrieve all countries ordered by name
      operationId: getCountries
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CountryResponse'

  /api/brokers/countries/{countryId}/counties:
    get:
      tags:
        - Geography
      summary: Get counties by country
      description: Retrieve all counties for a specific country, ordered by name
      operationId: getCountiesByCountry
      parameters:
        - name: countryId
          in: path
          required: true
          description: Country UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CountyResponse'
        '404':
          description: Country not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/brokers/counties/{countyId}/cities:
    get:
      tags:
        - Geography
      summary: Get cities by county
      description: Retrieve all cities for a specific county, ordered by name
      operationId: getCitiesByCounty
      parameters:
        - name: countyId
          in: path
          required: true
          description: County UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CityResponse'
        '404':
          description: County not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/brokers/policies:
    get:
      tags:
        - Policies
      summary: List policies
      description: List policies with optional filters and pagination
      operationId: listPolicies
      parameters:
        - name: clientId
          in: query
          description: Filter by client ID
          required: false
          schema:
            type: string
            format: uuid
        - name: brokerId
          in: query
          description: Filter by broker ID
          required: false
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          description: Filter by policy status
          required: false
          schema:
            type: string
            enum: [DRAFT, ACTIVE, CANCELLED]
        - name: startDate
          in: query
          description: Filter by start date (from)
          required: false
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          description: Filter by end date (to)
          required: false
          schema:
            type: string
            format: date
        - name: page
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Page size
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: sort
          in: query
          description: Sort field and direction
          required: false
          schema:
            type: string
            default: "createdAt,desc"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageDtoPolicySummaryResponse'

    post:
      tags:
        - Policies
      summary: Create policy draft
      description: Create a new policy in DRAFT status
      operationId: createPolicyDraft
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePolicyRequest'
      responses:
        '201':
          description: Policy draft created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/brokers/policies/{id}:
    get:
      tags:
        - Policies
      summary: Get policy by ID
      description: Retrieve detailed policy information
      operationId: getPolicyById
      parameters:
        - name: id
          in: path
          required: true
          description: Policy UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyDetailResponse'
        '404':
          description: Policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/brokers/policies/{id}/activate:
    post:
      tags:
        - Policies
      summary: Activate policy
      description: Activate a policy from DRAFT status to ACTIVE
      operationId: activatePolicy
      parameters:
        - name: id
          in: path
          required: true
          description: Policy UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Policy activated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyResponse'
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/brokers/policies/{id}/cancel:
    post:
      tags:
        - Policies
      summary: Cancel policy
      description: Cancel an active policy
      operationId: cancelPolicy
      parameters:
        - name: id
          in: path
          required: true
          description: Policy UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelPolicyRequest'
      responses:
        '200':
          description: Policy cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyResponse'
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/brokers:
    get:
      tags:
        - Brokers (Admin)
      summary: List brokers
      description: List all brokers with pagination
      operationId: listBrokers
      parameters:
        - name: page
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Page size
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: sort
          in: query
          description: Sort field and direction
          required: false
          schema:
            type: string
            default: "name,asc"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageDtoBrokerResponse'

    post:
      tags:
        - Brokers (Admin)
      summary: Create broker
      description: Create a new broker
      operationId: createBroker
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBrokerRequest'
      responses:
        '201':
          description: Broker created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrokerResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/brokers/{id}:
    get:
      tags:
        - Brokers (Admin)
      summary: Get broker by ID
      description: Retrieve broker details
      operationId: getBrokerById
      parameters:
        - name: id
          in: path
          required: true
          description: Broker UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrokerResponse'
        '404':
          description: Broker not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

    put:
      tags:
        - Brokers (Admin)
      summary: Update broker
      description: Update broker information
      operationId: updateBroker
      parameters:
        - name: id
          in: path
          required: true
          description: Broker UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateBrokerRequest'
      responses:
        '200':
          description: Broker updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrokerResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Broker not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/brokers/{id}/activate:
    post:
      tags:
        - Brokers (Admin)
      summary: Activate broker
      description: Activate a broker
      operationId: activateBroker
      parameters:
        - name: id
          in: path
          required: true
          description: Broker UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Broker activated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrokerResponse'
        '404':
          description: Broker not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/brokers/{id}/deactivate:
    post:
      tags:
        - Brokers (Admin)
      summary: Deactivate broker
      description: Deactivate a broker
      operationId: deactivateBroker
      parameters:
        - name: id
          in: path
          required: true
          description: Broker UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Broker deactivated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrokerResponse'
        '404':
          description: Broker not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/currencies:
    get:
      tags:
        - Currencies (Admin)
      summary: List currencies
      description: List all currencies with pagination
      operationId: listCurrencies
      parameters:
        - name: page
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Page size
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: sort
          in: query
          description: Sort field and direction
          required: false
          schema:
            type: string
            default: "code,asc"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageDtoCurrencyResponse'

    post:
      tags:
        - Currencies (Admin)
      summary: Create currency
      description: Create a new currency
      operationId: createCurrency
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCurrencyRequest'
      responses:
        '201':
          description: Currency created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrencyResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/currencies/{currencyId}/actions:
    post:
      tags:
        - Currencies (Admin)
      summary: Execute currency action
      description: Execute an action on a currency (ACTIVATE or DEACTIVATE)
      operationId: executeCurrencyAction
      parameters:
        - name: currencyId
          in: path
          required: true
          description: Currency UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CurrencyActionRequest'
      responses:
        '200':
          description: Action executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrencyResponse'
        '400':
          description: Invalid action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Currency not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/fees:
    get:
      tags:
        - Fees (Admin)
      summary: List fee configurations
      description: List all fee configurations with pagination
      operationId: listFeeConfigurations
      parameters:
        - name: page
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Page size
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: sort
          in: query
          description: Sort field and direction
          required: false
          schema:
            type: string
            default: "code,asc"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageDtoFeeConfigResponse'

    post:
      tags:
        - Fees (Admin)
      summary: Create fee configuration
      description: Create a new fee configuration
      operationId: createFeeConfiguration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFeeConfigRequest'
      responses:
        '201':
          description: Fee configuration created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeeConfigResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/fees/{id}:
    put:
      tags:
        - Fees (Admin)
      summary: Update fee configuration
      description: Update fee configuration details
      operationId: updateFeeConfiguration
      parameters:
        - name: id
          in: path
          required: true
          description: Fee configuration UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateFeeConfigRequest'
      responses:
        '200':
          description: Fee configuration updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeeConfigResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Fee configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/fees/{id}/deactivate:
    post:
      tags:
        - Fees (Admin)
      summary: Deactivate fee configuration
      description: Deactivate a fee configuration
      operationId: deactivateFeeConfiguration
      parameters:
        - name: id
          in: path
          required: true
          description: Fee configuration UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Fee configuration deactivated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeeConfigResponse'
        '404':
          description: Fee configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/risk-factors:
    get:
      tags:
        - Risk Factors (Admin)
      summary: List risk factors
      description: List all risk factors with pagination
      operationId: listRiskFactors
      parameters:
        - name: page
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Page size
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: sort
          in: query
          description: Sort field and direction
          required: false
          schema:
            type: string
            default: "createdAt,desc"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageDtoRiskFactorResponse'

    post:
      tags:
        - Risk Factors (Admin)
      summary: Create risk factor
      description: Create a new risk factor
      operationId: createRiskFactor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRiskFactorRequest'
      responses:
        '201':
          description: Risk factor created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskFactorResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/risk-factors/{id}:
    put:
      tags:
        - Risk Factors (Admin)
      summary: Update risk factor percentage
      description: Update risk factor adjustment percentage
      operationId: updateRiskFactorPercentage
      parameters:
        - name: id
          in: path
          required: true
          description: Risk factor UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRiskFactorPercentageRequest'
      responses:
        '200':
          description: Risk factor updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskFactorResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Risk factor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/risk-factors/{id}/actions:
    post:
      tags:
        - Risk Factors (Admin)
      summary: Execute risk factor action
      description: Execute an action on a risk factor (ACTIVATE or DEACTIVATE)
      operationId: executeRiskFactorAction
      parameters:
        - name: id
          in: path
          required: true
          description: Risk factor UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RiskFactorActionRequest'
      responses:
        '200':
          description: Action executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskFactorResponse'
        '400':
          description: Invalid action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          description: Risk factor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/reports/policies-by-country:
    get:
      tags:
        - Reports (Admin)
      summary: Policy report by country
      description: Generate policy report grouped by country
      operationId: reportPoliciesByCountry
      parameters:
        - name: from
          in: query
          required: true
          description: Start date for report
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: true
          description: End date for report
          schema:
            type: string
            format: date
        - name: status
          in: query
          required: false
          description: Filter by policy status
          schema:
            type: string
        - name: currency
          in: query
          required: false
          description: Filter by currency code
          schema:
            type: string
        - name: buildingType
          in: query
          required: false
          description: Filter by building type
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PolicyReportResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/reports/policies-by-county:
    get:
      tags:
        - Reports (Admin)
      summary: Policy report by county
      description: Generate policy report grouped by county
      operationId: reportPoliciesByCounty
      parameters:
        - name: from
          in: query
          required: true
          description: Start date for report
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: true
          description: End date for report
          schema:
            type: string
            format: date
        - name: status
          in: query
          required: false
          description: Filter by policy status
          schema:
            type: string
        - name: currency
          in: query
          required: false
          description: Filter by currency code
          schema:
            type: string
        - name: buildingType
          in: query
          required: false
          description: Filter by building type
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PolicyReportResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/reports/policies-by-city:
    get:
      tags:
        - Reports (Admin)
      summary: Policy report by city
      description: Generate policy report grouped by city
      operationId: reportPoliciesByCity
      parameters:
        - name: from
          in: query
          required: true
          description: Start date for report
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: true
          description: End date for report
          schema:
            type: string
            format: date
        - name: status
          in: query
          required: false
          description: Filter by policy status
          schema:
            type: string
        - name: currency
          in: query
          required: false
          description: Filter by currency code
          schema:
            type: string
        - name: buildingType
          in: query
          required: false
          description: Filter by building type
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PolicyReportResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/admin/reports/policies-by-broker:
    get:
      tags:
        - Reports (Admin)
      summary: Policy report by broker
      description: Generate policy report grouped by broker
      operationId: reportPoliciesByBroker
      parameters:
        - name: from
          in: query
          required: true
          description: Start date for report
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: true
          description: End date for report
          schema:
            type: string
            format: date
        - name: status
          in: query
          required: false
          description: Filter by policy status
          schema:
            type: string
        - name: currency
          in: query
          required: false
          description: Filter by currency code
          schema:
            type: string
        - name: buildingType
          in: query
          required: false
          description: Filter by building type
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PolicyReportResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

components:
  schemas:
    # Client Schemas
    CreateClientRequest:
      type: object
      required:
        - clientType
        - name
        - identificationNumber
        - contactInfo
      properties:
        clientType:
          type: string
          enum: [INDIVIDUAL, COMPANY]
          description: Type of client
          example: INDIVIDUAL
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: Client name or company name
          example: "John Doe"
        identificationNumber:
          type: string
          pattern: '^(?:\d{13}|\d{2,10})$'
          description: CNP (13 digits) for individuals or CUI (2-10 digits) for companies
          example: "1234567890123"
        contactInfo:
          $ref: '#/components/schemas/ContactInfoRequest'
        address:
          $ref: '#/components/schemas/AddressRequest'

    UpdateClientRequest:
      type: object
      required:
        - name
        - contactInfo
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: Client name or company name
          example: "Jane Doe"
        identificationNumber:
          type: string
          pattern: '^[0-9]{13}$|^[0-9]{2,10}$'
          description: New CNP or CUI (changes are tracked automatically)
          example: "9876543210987"
        contactInfo:
          $ref: '#/components/schemas/ContactInfoRequest'
        address:
          $ref: '#/components/schemas/AddressRequest'

    ContactInfoRequest:
      type: object
      required:
        - email
        - phone
      properties:
        email:
          type: string
          format: email
          maxLength: 100
          description: Email address
          example: "john.doe@example.com"
        phone:
          type: string
          pattern: '^\+?[0-9]{10,15}$'
          description: Phone number
          example: "+40712345678"

    AddressRequest:
      type: object
      required:
        - street
        - city
        - country
      properties:
        street:
          type: string
          maxLength: 200
          description: Street name
          example: "Main Street"
        city:
          type: string
          maxLength: 100
          description: City name
          example: "Bucharest"
        county:
          type: string
          maxLength: 100
          description: County name (optional)
          example: "Bucuresti"
        postalCode:
          type: string
          pattern: '^[0-9]{6}$'
          description: 6-digit postal code (optional)
          example: "123456"
        country:
          type: string
          maxLength: 100
          description: Country name
          example: "Romania"

    ClientResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Client unique identifier
        clientType:
          type: string
          enum: [INDIVIDUAL, COMPANY]
          description: Type of client
        name:
          type: string
          description: Client name or company name
        identificationNumber:
          type: string
          description: CNP or CUI
        contactInfo:
          $ref: '#/components/schemas/ContactInfoResponse'
        address:
          $ref: '#/components/schemas/AddressResponse'
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
        identificationNumberHistory:
          type: array
          description: History of identification number changes
          items:
            $ref: '#/components/schemas/IdentificationNumberChangeDto'

    ContactInfoResponse:
      type: object
      properties:
        email:
          type: string
          format: email
        phone:
          type: string

    AddressResponse:
      type: object
      properties:
        street:
          type: string
        city:
          type: string
        county:
          type: string
        postalCode:
          type: string
        country:
          type: string

    IdentificationNumberChangeDto:
      type: object
      properties:
        changedAt:
          type: string
          format: date-time
          description: When the change occurred
        changedBy:
          type: string
          description: Who made the change
        changeReason:
          type: string
          description: Reason for the change

    PageDtoClientResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/ClientResponse'
        page:
          type: integer
          description: Current page number (0-indexed)
        size:
          type: integer
          description: Page size
        totalElements:
          type: integer
          format: int64
          description: Total number of elements
        totalPages:
          type: integer
          description: Total number of pages

    # Building Schemas
    CreateBuildingRequest:
      type: object
      required:
        - street
        - streetNumber
        - cityId
        - constructionYear
        - buildingType
        - surfaceArea
        - insuredValue
      properties:
        street:
          type: string
          maxLength: 200
          description: Street name
          example: "Main Street"
        streetNumber:
          type: string
          maxLength: 20
          description: Street number
          example: "123"
        cityId:
          type: string
          format: uuid
          description: City UUID from geography
          example: "f1d2c3b4-5a6b-4c8d-9e0f-112233445566"
        constructionYear:
          type: integer
          minimum: 1800
          maximum: 2100
          description: Year of construction
          example: 2020
        buildingType:
          type: string
          enum: [RESIDENTIAL, OFFICE, INDUSTRIAL]
          description: Type of building
          example: RESIDENTIAL
        numberOfFloors:
          type: integer
          minimum: 1
          maximum: 200
          description: Number of floors (optional)
          example: 5
        surfaceArea:
          type: number
          format: double
          minimum: 0.01
          description: Surface area in square meters
          example: 150.50
        insuredValue:
          type: number
          format: double
          minimum: 0.01
          description: Insured value in currency
          example: 200000.00
        floodZone:
          type: boolean
          description: Is building in flood risk zone
          example: false
        earthquakeRiskZone:
          type: boolean
          description: Is building in earthquake risk zone
          example: true

    UpdateBuildingRequest:
      type: object
      required:
        - street
        - streetNumber
        - cityId
        - constructionYear
        - buildingType
        - surfaceArea
        - insuredValue
      properties:
        street:
          type: string
          maxLength: 200
          description: Street name
          example: "New Street"
        streetNumber:
          type: string
          maxLength: 20
          description: Street number
          example: "456"
        cityId:
          type: string
          format: uuid
          description: City UUID from geography
          example: "f1d2c3b4-5a6b-4c8d-9e0f-112233445566"
        constructionYear:
          type: integer
          minimum: 1800
          maximum: 2100
          description: Year of construction
          example: 2021
        buildingType:
          type: string
          enum: [RESIDENTIAL, OFFICE, INDUSTRIAL]
          description: Type of building
          example: OFFICE
        numberOfFloors:
          type: integer
          minimum: 1
          maximum: 200
          description: Number of floors (optional)
          example: 10
        surfaceArea:
          type: number
          format: double
          minimum: 0.01
          description: Surface area in square meters
          example: 300.00
        insuredValue:
          type: number
          format: double
          minimum: 0.01
          description: Insured value in currency
          example: 500000.00
        floodZone:
          type: boolean
          description: Is building in flood risk zone
          example: true
        earthquakeRiskZone:
          type: boolean
          description: Is building in earthquake risk zone
          example: false

    BuildingResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Building unique identifier
        ownerId:
          type: string
          format: uuid
          description: Owner client UUID (immutable)
        ownerName:
          type: string
          description: Owner client name
        street:
          type: string
          description: Street name
        streetNumber:
          type: string
          description: Street number
        city:
          $ref: '#/components/schemas/CityResponse'
        county:
          $ref: '#/components/schemas/CountyResponse'
        country:
          $ref: '#/components/schemas/CountryResponse'
        constructionYear:
          type: integer
          description: Year of construction
        buildingType:
          type: string
          enum: [RESIDENTIAL, OFFICE, INDUSTRIAL]
          description: Type of building
        numberOfFloors:
          type: integer
          description: Number of floors
        surfaceArea:
          type: number
          format: double
          description: Surface area in square meters
        insuredValue:
          type: number
          format: double
          description: Insured value in currency
        floodZone:
          type: boolean
          description: Is building in flood risk zone
        earthquakeRiskZone:
          type: boolean
          description: Is building in earthquake risk zone
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    # Geography Schemas
    CountryResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Country unique identifier
        name:
          type: string
          description: Country name
          example: "Romania"

    CountyResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: County unique identifier
        name:
          type: string
          description: County name
          example: "Bucuresti"
        code:
          type: string
          description: County code
          example: "B"

    CityResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: City unique identifier
        name:
          type: string
          description: City name
          example: "Sector 1"

    # Policy Schemas
    CreatePolicyRequest:
      type: object
      required:
        - clientId
        - buildingId
        - brokerId
        - currencyId
        - basePremium
        - startDate
        - endDate
      properties:
        clientId:
          type: string
          format: uuid
          description: Client UUID
        buildingId:
          type: string
          format: uuid
          description: Building UUID
        brokerId:
          type: string
          format: uuid
          description: Broker UUID
        currencyId:
          type: string
          format: uuid
          description: Currency UUID
        basePremium:
          type: number
          format: double
          minimum: 0.01
          description: Base premium amount
          example: 1000.00
        startDate:
          type: string
          format: date
          description: Policy start date (must not be in the past)
          example: "2026-03-01"
        endDate:
          type: string
          format: date
          description: Policy end date
          example: "2027-03-01"

    CancelPolicyRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          maxLength: 500
          description: Cancellation reason
          example: "Client requested cancellation"

    PolicyResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        policyNumber:
          type: string
          description: Auto-generated policy number
        status:
          type: string
          enum: [DRAFT, ACTIVE, CANCELLED]
        clientId:
          type: string
          format: uuid
        buildingId:
          type: string
          format: uuid
        brokerId:
          type: string
          format: uuid
        currencyCode:
          type: string
          description: Currency code (e.g., RON, EUR)
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        basePremium:
          type: number
          format: double
        finalPremium:
          type: number
          format: double
          description: Calculated premium with fees and risk factors
        cancelledAt:
          type: string
          format: date
          nullable: true
        cancellationReason:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PolicySummaryResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        policyNumber:
          type: string
        status:
          type: string
          enum: [DRAFT, ACTIVE, CANCELLED]
        clientId:
          type: string
          format: uuid
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        finalPremium:
          type: number
          format: double
        currencyCode:
          type: string

    PolicyDetailResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        policyNumber:
          type: string
        status:
          type: string
          enum: [DRAFT, ACTIVE, CANCELLED]
        client:
          type: object
          description: Client reference information
        building:
          type: object
          description: Building detailed information
        brokerId:
          type: string
          format: uuid
        currency:
          type: object
          description: Currency reference information
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        basePremium:
          type: number
          format: double
        finalPremium:
          type: number
          format: double
        cancelledAt:
          type: string
          format: date
          nullable: true
        cancellationReason:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PageDtoPolicySummaryResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/PolicySummaryResponse'
        page:
          type: integer
        size:
          type: integer
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer

    # Broker Schemas
    CreateBrokerRequest:
      type: object
      required:
        - brokerCode
        - name
        - email
        - active
      properties:
        brokerCode:
          type: string
          minLength: 3
          maxLength: 30
          description: Unique broker code
          example: "BRK001"
        name:
          type: string
          minLength: 2
          maxLength: 120
          description: Broker name
          example: "ABC Insurance Brokers"
        email:
          type: string
          format: email
          maxLength: 100
          example: "contact@abcbrokers.com"
        phone:
          type: string
          pattern: '^\+?\d{10,15}$'
          example: "+40712345678"
        commissionPercentage:
          type: number
          format: double
          minimum: 0.0
          maximum: 1.0
          exclusiveMinimum: true
          description: Commission percentage (0.0 to 1.0)
          example: 0.15
        active:
          type: boolean
          description: Active status
          example: true

    UpdateBrokerRequest:
      type: object
      required:
        - name
        - email
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 120
          example: "ABC Insurance Brokers Ltd"
        email:
          type: string
          format: email
          maxLength: 100
          example: "info@abcbrokers.com"
        phone:
          type: string
          pattern: '^\+?\d{10,15}$'
          example: "+40712345679"
        commissionPercentage:
          type: number
          format: double
          minimum: 0.0
          maximum: 1.0
          exclusiveMinimum: true
          example: 0.18

    BrokerResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        brokerCode:
          type: string
        name:
          type: string
        email:
          type: string
        phone:
          type: string
        status:
          type: string
          description: Broker status (ACTIVE/INACTIVE)
        commissionPercentage:
          type: number
          format: double
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PageDtoBrokerResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/BrokerResponse'
        page:
          type: integer
        size:
          type: integer
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer

    # Currency Schemas
    CreateCurrencyRequest:
      type: object
      required:
        - code
        - name
        - exchangeRateToBase
        - isActive
      properties:
        code:
          type: string
          minLength: 3
          maxLength: 3
          pattern: '^[A-Z]{3}$'
          description: ISO 4217 currency code
          example: "EUR"
        name:
          type: string
          minLength: 3
          maxLength: 100
          description: Currency name
          example: "Euro"
        exchangeRateToBase:
          type: number
          format: double
          minimum: 0.000001
          description: Exchange rate to base currency
          example: 0.2
        isActive:
          type: boolean
          description: Active status
          example: true

    CurrencyActionRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum: [ACTIVATE, DEACTIVATE]
          description: Action to execute
          example: "ACTIVATE"

    CurrencyResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        code:
          type: string
          description: ISO 4217 currency code
        name:
          type: string
        exchangeRateToBase:
          type: number
          format: double
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PageDtoCurrencyResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/CurrencyResponse'
        page:
          type: integer
        size:
          type: integer
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer

    # Fee Configuration Schemas
    CreateFeeConfigRequest:
      type: object
      required:
        - code
        - name
        - type
        - percentage
        - effectiveFrom
        - isActive
      properties:
        code:
          type: string
          minLength: 3
          maxLength: 50
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique fee code (uppercase with underscores)
          example: "STANDARD_BROKER_FEE"
        name:
          type: string
          maxLength: 200
          description: Fee name
          example: "Standard Broker Fee"
        type:
          type: string
          enum: [BROKER_COMMISSION, RISK_ADJUSTMENT, ADMIN_FEE]
          description: Fee type
          example: "BROKER_COMMISSION"
        percentage:
          type: number
          format: double
          minimum: 0.0
          maximum: 0.5
          exclusiveMinimum: true
          description: Fee percentage (0.0 to 0.5)
          example: 0.05
        effectiveFrom:
          type: string
          format: date
          description: Effective start date
          example: "2026-01-01"
        effectiveTo:
          type: string
          format: date
          nullable: true
          description: Effective end date (optional)
          example: "2026-12-31"
        isActive:
          type: boolean
          description: Active status
          example: true

    UpdateFeeConfigRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 200
          example: "Updated Broker Fee"
        percentage:
          type: number
          format: double
          minimum: 0.0
          maximum: 0.5
          exclusiveMinimum: true
          example: 0.06
        effectiveTo:
          type: string
          format: date
          nullable: true
          example: "2027-12-31"

    FeeConfigResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        code:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [BROKER_COMMISSION, RISK_ADJUSTMENT, ADMIN_FEE]
        percentage:
          type: number
          format: double
        effectiveFrom:
          type: string
          format: date
        effectiveTo:
          type: string
          format: date
          nullable: true
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PageDtoFeeConfigResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/FeeConfigResponse'
        page:
          type: integer
        size:
          type: integer
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer

    # Risk Factor Schemas
    CreateRiskFactorRequest:
      type: object
      required:
        - level
        - adjustmentPercentage
        - active
      properties:
        level:
          type: string
          enum: [COUNTRY, COUNTY, CITY, BUILDING_TYPE]
          description: Risk factor level
          example: "CITY"
        referenceId:
          type: string
          format: uuid
          nullable: true
          description: Reference ID (country/county/city UUID, null for BUILDING_TYPE)
        buildingType:
          type: string
          enum: [RESIDENTIAL, OFFICE, INDUSTRIAL]
          nullable: true
          description: Building type (only for BUILDING_TYPE level)
        adjustmentPercentage:
          type: number
          format: double
          minimum: -0.5
          maximum: 1.0
          description: Adjustment percentage (-0.5 to 1.0)
          example: 0.15
        active:
          type: boolean
          description: Active status
          example: true

    UpdateRiskFactorPercentageRequest:
      type: object
      required:
        - adjustmentPercentage
      properties:
        adjustmentPercentage:
          type: number
          format: double
          minimum: -0.5
          maximum: 1.0
          description: Adjustment percentage (-0.5 to 1.0)
          example: 0.20

    RiskFactorActionRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum: [ACTIVATE, DEACTIVATE]
          description: Action to execute
          example: "ACTIVATE"

    RiskFactorResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        level:
          type: string
          enum: [COUNTRY, COUNTY, CITY, BUILDING_TYPE]
        referenceId:
          type: string
          format: uuid
          nullable: true
        buildingType:
          type: string
          enum: [RESIDENTIAL, OFFICE, INDUSTRIAL]
          nullable: true
        adjustmentPercentage:
          type: number
          format: double
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PageDtoRiskFactorResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/RiskFactorResponse'
        page:
          type: integer
        size:
          type: integer
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer

    # Report Schemas
    PolicyReportResponse:
      type: object
      properties:
        groupingKey:
          type: string
          description: Grouping key (country/county/city/broker name)
          example: "Romania"
        currencyCode:
          type: string
          description: Currency code
          example: "RON"
        policyCount:
          type: integer
          format: int64
          description: Number of policies
          example: 150
        totalFinalPremium:
          type: number
          format: double
          description: Total final premium in original currency
          example: 500000.00
        totalFinalPremiumInBaseCurrency:
          type: number
          format: double
          description: Total final premium converted to base currency
          example: 100000.00

    # Error Schema (RFC 7807 Problem Details)
    ProblemDetail:
      type: object
      properties:
        type:
          type: string
          description: URI reference identifying the problem type
          example: "urn:problem:validation-error"
        title:
          type: string
          description: Short, human-readable summary
          example: "Bad Request"
        status:
          type: integer
          description: HTTP status code
          example: 400
        detail:
          type: string
          description: Human-readable explanation
          example: "Validation failed"
        instance:
          type: string
          description: URI reference identifying the specific occurrence
          example: "/api/brokers/clients"
        code:
          type: string
          description: Application-specific error code
          example: "VALIDATION_ERROR"
        errors:
          type: object
          additionalProperties:
            type: string
          description: Field-level validation errors (for validation errors)
          example:
            name: "Name is required"
            email: "Email must be valid"
        resource:
          type: string
          description: Resource type (for not found errors)
          example: "Client"
        field:
          type: string
          description: Field name (for not found errors)
          example: "id"
        identificationNumber:
          type: string
          description: Conflicting identification number (for duplicate errors)
          example: "1234567890123"
